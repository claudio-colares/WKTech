  {------------------------------------------+
  |  SISTEMA.........: Teste WK Technology   |
  |  LINGUAGEM/DB....: Delphi 10.3/Mysql 5.7 |
  |  ANO.............: 2024                  |
  |------------------------------------------|
  |  Programadores/autores:                  |
  |  - Claudio A. Colares                    |
  +------------------------------------------}

unit RecordBancoDados;

interface

uses
  Winapi.Windows,
  Winapi.Messages,
  System.SysUtils,
  System.Variants,
  System.Classes,
  Vcl.Graphics,
  Vcl.Controls,
  Vcl.Forms,
  Vcl.Dialogs,
  System.IniFiles,
  Data.DB,
  App.Constantes,
  FireDAC.Comp.Client,
  FireDAC.Phys.FB;

Type

  TBancoDados = Record
    DriverID: String;
    Gerenciador: String;
    BaseDados: String;
    IPDNS: String;
    Porta: Integer;
    Usuario: String;
    Senha: String;
    BaseInCloud: Boolean;
  private
  Public
    procedure Limpar;
    procedure GetDadosParametros;
    procedure VerificarINI;
    procedure GravarINI;
    procedure GetDriverLink(var aDriverLink: TFDPhysFBDriverLink);
    procedure GetConfigFB(var aFDConnection: TFDConnection);
  end;

implementation

{ TBancoDados }


procedure TBancoDados.Limpar;
begin
  DriverID    := '';
  Gerenciador := '';
  BaseDados   := '';
  IPDNS       := '';
  Porta       := 0;
  Usuario     := '';
  Senha       := '';
  BaseInCloud := False;
end;

procedure TBancoDados.VerificarINI;
begin
  if FileExists(_ARQUIVO_INI) = False then
  begin
    Limpar;
    GetDadosParametros;
    GravarINI;
  end;
end;

procedure TBancoDados.GetDadosParametros;
var
  IniFile: TIniFile;
begin
  Limpar;

  // --------------------------------------------------------------------
  // Parametros do Banco de Dados
  // --------------------------------------------------------------------
  try
    IniFile            := TIniFile.Create(_ARQUIVO_INI);
    _DATABASE_SERVIDOR := IniFile.ReadString(_SECAO_SERVIDOR, _CHAVE_IPSERVIDOR, '127.0.0.1');
    _DATABASE_PORTA    := IniFile.ReadInteger(_SECAO_SERVIDOR, _CHAVE_PORTA, 3050);
    _BANCO_DADOS_FDB   := IniFile.ReadString(_SECAO_SERVIDOR, _CHAVE_BASEDADOS, _PASTASISTEMA + 'dados\' + _DATEBASE_DEFAULT);
    _DATABASE_USUARIO  := DecryptStr(IniFile.ReadString(_SECAO_SERVIDOR, _CHAVE_USUARIO, '5207716AA7B7'));
    _DATABASE_SENHA    := DecryptStr(IniFile.ReadString(_SECAO_SERVIDOR, _CHAVE_SENHA, '6CF3663E6EAF27BE4F'));
    _DATABASE_IN_CLOUD := IniFile.ReadBool(_SECAO_SERVIDOR, _CHAVE_CLOUD, False);

  finally
    IniFile.Free;
  end;

  DriverID    := _DATABASE_DRIVER;
  Gerenciador := _DATABASE_GERENCIADOR;
  BaseDados   := _BANCO_DADOS_FDB;
  IPDNS       := _DATABASE_SERVIDOR;
  Porta       := _DATABASE_PORTA;
  Usuario     := _DATABASE_USUARIO;
  Senha       := _DATABASE_SENHA;
  BaseInCloud := _DATABASE_IN_CLOUD;

end;

procedure TBancoDados.GravarINI;
var
  mArqINI            : TIniFile;
  mUsuarioEncripitado: string;
  mSenhaEncriptada   : String;
begin
  mUsuarioEncripitado := EncryptStr(Usuario);
  mSenhaEncriptada    := EncryptStr(Senha);

  if FileExists(_ARQUIVO_INI) then
    DeleteFile(_ARQUIVO_INI);

  mArqINI := TIniFile.Create(_ARQUIVO_INI);
  try
    mArqINI.WriteString(_SECAO_SERVIDOR, _CHAVE_BASEDADOS, BaseDados);
    mArqINI.WriteString(_SECAO_SERVIDOR, _CHAVE_IPSERVIDOR, IPDNS);
    mArqINI.WriteInteger(_SECAO_SERVIDOR, _CHAVE_PORTA, Porta);
    mArqINI.WriteString(_SECAO_SERVIDOR, _CHAVE_USUARIO, mUsuarioEncripitado);
    mArqINI.WriteString(_SECAO_SERVIDOR, _CHAVE_SENHA, mSenhaEncriptada);
    mArqINI.WriteBool(_SECAO_SERVIDOR, _CHAVE_CLOUD, BaseInCloud);
  finally
    mArqINI.Free;
  end;
end;

procedure TBancoDados.GetConfigFB(var aFDConnection: TFDConnection);
var
  mPorta: String;
begin
  mPorta := '';
  if Porta > 0 then
    mPorta := Porta.ToString;

  if (aFDConnection = nil) then
  begin
    raise Exception.Create('Objeto TFDConnection não instanciado.');
  end;
  GetDadosParametros;
  GravarINI;
  aFDConnection.Params.Values['DriverID']  := DriverID;
  aFDConnection.Params.Values['Server']    := IPDNS;
  aFDConnection.Params.Values['Database']  := BaseDados;
  aFDConnection.Params.Values['User_Name'] := Usuario;
  aFDConnection.Params.Values['Password']  := Senha;
  aFDConnection.Params.Values['Port']      := mPorta;
end;

procedure TBancoDados.GetDriverLink(var aDriverLink: TFDPhysFBDriverLink);
begin
  if (aDriverLink = nil) then
  begin
    raise Exception.Create('Objeto TFDPhysFBDriverLink não instanciado.');
  end;

  aDriverLink.DriverID  := _DATABASE_DRIVER;
  aDriverLink.VendorLib := _DATABASE_VENDORLIBDLL;
end;

end.
